<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Repo Explorer</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
    }
    a {
      color: #0af;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    #progressContainer {
      margin: 10px 0;
      display: none;
    }
    #progressBar {
      width: 100%;
      height: 20px;
    }
  </style>
</head>
<body>
  <h2>Repo Explorer</h2>
  <div id="fileList"></div>

  <div id="progressContainer">
    <p>üì¶ Building ZIP... Please wait</p>
    <progress id="progressBar" value="0" max="100"></progress>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const historyStack = [];

    async function openRepo(repo, path = "") {
      historyStack.push({ repo, path });

      const list = document.getElementById("fileList");
      list.innerHTML = `<h3>Browsing: ${repo}/${path}</h3>
        <button id="backBtn">‚¨Ö Go Back</button>
        <p><button id="zipBtn">üì¶ Download This Folder as ZIP</button></p>
        <ul id="items"></ul>`;

      document.getElementById("zipBtn").addEventListener("click", () => {
        downloadFolderAsZip(repo, path);
      });

      const res = await fetch(getApiUrl(repo, path));
      if (!res.ok) {
        document.getElementById("items").innerHTML = `<li>‚ùå Failed to load</li>`;
        return;
      }
      const data = await res.json();

      const ul = document.getElementById("items");

      data.filter(item => item.type === "dir").forEach(d => {
        const li = document.createElement("li");
        li.textContent = "üìÇ " + d.name;

        const browse = document.createElement("a");
        browse.href = "#";
        browse.textContent = " [Browse]";
        browse.addEventListener("click", e => {
          e.preventDefault();
          openRepo(repo, path + d.name + "/");
        });

        const zip = document.createElement("a");
        zip.href = "#";
        zip.textContent = " [ZIP]";
        zip.style.marginLeft = "5px";
        zip.addEventListener("click", e => {
          e.preventDefault();
          downloadFolderAsZip(repo, path + d.name + "/");
        });

        li.appendChild(browse);
        li.appendChild(zip);
        ul.appendChild(li);
      });

      data.filter(item => item.type === "file").forEach(f => {
        const li = document.createElement("li");
        li.textContent = "üìÑ " + f.name;

        const open = document.createElement("a");
        open.href = f.download_url;
        open.textContent = " [Download]";
        open.setAttribute("download", f.name);

        li.appendChild(open);
        ul.appendChild(li);
      });

      document.getElementById("backBtn").addEventListener("click", () => goBack());
    }

    function goBack() {
      historyStack.pop();
      if (historyStack.length > 0) {
        const prev = historyStack.pop();
        openRepo(prev.repo, prev.path);
      } else {
        document.getElementById("fileList").innerHTML = "<p>üè† Back at root</p>";
      }
    }

    // --- ZIP download with progress ---
    async function downloadFolderAsZip(repo, path) {
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      progressContainer.style.display = "block";
      progressBar.value = 0;

      const zip = new JSZip();
      let filesProcessed = 0;
      let totalFiles = await countFiles(repo, path);

      await addFolderToZip(zip, repo, path, () => {
        filesProcessed++;
        progressBar.value = (filesProcessed / totalFiles) * 100;
      });

      const folderName = path === "" ? repo : path.split("/").filter(Boolean).pop();
      const blob = await zip.generateAsync({ type: "blob" });
      saveAs(blob, folderName + ".zip");

      progressContainer.style.display = "none";
    }

    async function countFiles(repo, path) {
      const res = await fetch(getApiUrl(repo, path));
      const data = await res.json();
      let count = 0;
      for (const item of data) {
        if (item.type === "file") count++;
        if (item.type === "dir") count += await countFiles(repo, path + item.name + "/");
      }
      return count;
    }

    async function addFolderToZip(zip, repo, path, onProgress) {
      const res = await fetch(getApiUrl(repo, path));
      const data = await res.json();

      for (const item of data) {
        if (item.type === "file") {
          const fileRes = await fetch(item.download_url);
          const blob = await fileRes.blob();
          zip.file(path + item.name, blob);
          onProgress();
        } else if (item.type === "dir") {
          const folder = zip.folder(path + item.name);
          await addFolderToZip(folder, repo, path + item.name + "/", onProgress);
        }
      }
    }

    function getApiUrl(repo, path) {
      if (repo === "main") {
        return `https://api.github.com/repos/55guh/55guh.github.io/contents/file/${path}`;
      }
      return `https://api.github.com/repos/55guh/${repo}/contents/${path}`;
    }

    // load default
    openRepo("main");
  </script>
</body>
</html>
